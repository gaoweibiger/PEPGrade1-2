<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•è¯­éŸ³é‡è¯•ä¿®å¤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid #4caf50;
        }
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success { background: rgba(76, 175, 80, 0.3); }
        .status.error { background: rgba(244, 67, 54, 0.3); }
        .status.loading { background: rgba(255, 193, 7, 0.3); }
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        .retry-counter {
            display: inline-block;
            background: #ff9800;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ è¯­éŸ³é‡è¯•æœºåˆ¶ä¿®å¤æµ‹è¯•</h1>
        
        <div class="controls">
            <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
            <button onclick="testNormalSpeech()">âœ… æµ‹è¯•æ­£å¸¸è¯­éŸ³</button>
            <button onclick="testFailureSpeech()">âŒ æ¨¡æ‹Ÿå¤±è´¥è¯­éŸ³</button>
            <button onclick="testRetryLimit()">ğŸ”„ æµ‹è¯•é‡è¯•é™åˆ¶</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ¯ ä¿®å¤å†…å®¹</h3>
            <div class="test-item">
                <strong>âœ… é˜²æ­¢é‡å¤ç‚¹å‡»ï¼š</strong> æ·»åŠ äº† isPlaying çŠ¶æ€æ£€æŸ¥
            </div>
            <div class="test-item">
                <strong>âœ… ç»Ÿä¸€é‡è¯•æ¬¡æ•°ï¼š</strong> æœ€å¤šé‡è¯•2æ¬¡ï¼Œé¿å…æ— é™å¾ªç¯
            </div>
            <div class="test-item">
                <strong>âœ… é€’å¢å»¶è¿Ÿï¼š</strong> ç¬¬1æ¬¡é‡è¯•1.5ç§’ï¼Œç¬¬2æ¬¡é‡è¯•3ç§’
            </div>
            <div class="test-item">
                <strong>âœ… ç»„ä»¶å¸è½½ä¿æŠ¤ï¼š</strong> é˜²æ­¢ç»„ä»¶å¸è½½åç»§ç»­é‡è¯•
            </div>
            <div class="test-item">
                <strong>âœ… è‡´å‘½é”™è¯¯è¯†åˆ«ï¼š</strong> ä¸å¯¹è‡´å‘½é”™è¯¯è¿›è¡Œé‡è¯•
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div id="testResults">
                <div class="status">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ è¯¦ç»†æ—¥å¿—</h3>
            <div id="logContainer" class="log">
                <div>å‡†å¤‡å¼€å§‹æµ‹è¯•...</div>
            </div>
        </div>
    </div>

    <script type="module">
        let testCount = 0;
        let retryCount = 0;
        let isTestRunning = false;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#ff6b6b' : 
                                 type === 'success' ? '#4caf50' : 
                                 type === 'warning' ? '#ff9800' : '#fff';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ¸…é™¤æ—¥å¿—
        window.clearLogs = function() {
            document.getElementById('logContainer').innerHTML = '<div>æ—¥å¿—å·²æ¸…é™¤...</div>';
            document.getElementById('testResults').innerHTML = '<div class="status">ç­‰å¾…æµ‹è¯•...</div>';
            testCount = 0;
            retryCount = 0;
        };

        // æ¨¡æ‹Ÿè¯­éŸ³åˆæˆAPI
        function mockSpeechSynthesis(shouldFail = false, failureType = 'normal') {
            return new Promise((resolve, reject) => {
                const delay = Math.random() * 1000 + 500; // 0.5-1.5ç§’éšæœºå»¶è¿Ÿ
                
                setTimeout(() => {
                    if (shouldFail) {
                        switch (failureType) {
                            case 'fatal':
                                reject(new Error('synthesis-failed: è‡´å‘½é”™è¯¯'));
                                break;
                            case 'network':
                                reject(new Error('network error: ç½‘ç»œè¿æ¥å¤±è´¥'));
                                break;
                            default:
                                resolve(false); // è¿”å›å¤±è´¥ä½†ä¸æŠ›å¼‚å¸¸
                        }
                    } else {
                        resolve(true); // æˆåŠŸ
                    }
                }, delay);
            });
        }

        // æ¨¡æ‹Ÿé‡è¯•é€»è¾‘
        async function simulateRetryLogic(text, maxRetries = 2, shouldFail = false, failureType = 'normal') {
            let currentRetry = 0;
            let isPlaying = false;

            const attempt = async () => {
                if (isPlaying) {
                    log('è¯­éŸ³æ­£åœ¨æ’­æ”¾ä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»', 'warning');
                    return false;
                }

                isPlaying = true;
                log(`å¼€å§‹æ’­æ”¾: "${text}" (å°è¯• ${currentRetry + 1}/${maxRetries + 1})`);

                try {
                    const success = await mockSpeechSynthesis(shouldFail, failureType);
                    
                    if (success) {
                        log(`æ’­æ”¾æˆåŠŸ: "${text}"`, 'success');
                        isPlaying = false;
                        return true;
                    } else {
                        log(`æ’­æ”¾å¤±è´¥: "${text}"`, 'error');
                        
                        if (currentRetry < maxRetries) {
                            currentRetry++;
                            const retryDelay = currentRetry * 1500; // é€’å¢å»¶è¿Ÿ
                            log(`å‡†å¤‡é‡è¯• (${currentRetry}/${maxRetries})ï¼Œå»¶è¿Ÿ ${retryDelay}ms`, 'warning');
                            
                            setTimeout(() => {
                                isPlaying = false;
                                attempt();
                            }, retryDelay);
                        } else {
                            log(`å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢é‡è¯•`, 'error');
                            isPlaying = false;
                            return false;
                        }
                    }
                } catch (error) {
                    log(`æ’­æ”¾å¼‚å¸¸: ${error.message}`, 'error');
                    
                    const isFatalError = error.message.includes('synthesis-failed') ||
                                       error.message.includes('network error');
                    
                    if (!isFatalError && currentRetry < maxRetries) {
                        currentRetry++;
                        const retryDelay = currentRetry * 1000;
                        log(`å¼‚å¸¸é‡è¯• (${currentRetry}/${maxRetries})ï¼Œå»¶è¿Ÿ ${retryDelay}ms`, 'warning');
                        
                        setTimeout(() => {
                            isPlaying = false;
                            attempt();
                        }, retryDelay);
                    } else {
                        if (isFatalError) {
                            log(`è‡´å‘½é”™è¯¯ï¼Œä¸é‡è¯•: ${error.message}`, 'error');
                        } else {
                            log(`å¼‚å¸¸é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œåœæ­¢é‡è¯•`, 'error');
                        }
                        isPlaying = false;
                        return false;
                    }
                }
            };

            return attempt();
        }

        // æµ‹è¯•æ­£å¸¸è¯­éŸ³
        window.testNormalSpeech = async function() {
            if (isTestRunning) return;
            isTestRunning = true;
            
            log('=== å¼€å§‹æµ‹è¯•æ­£å¸¸è¯­éŸ³æ’­æ”¾ ===');
            updateStatus('æ­£åœ¨æµ‹è¯•æ­£å¸¸è¯­éŸ³...', 'loading');
            
            const result = await simulateRetryLogic('Hello, this is a test', 2, false);
            
            if (result) {
                updateStatus('âœ… æ­£å¸¸è¯­éŸ³æµ‹è¯•é€šè¿‡', 'success');
                log('æ­£å¸¸è¯­éŸ³æµ‹è¯•å®Œæˆ', 'success');
            } else {
                updateStatus('âŒ æ­£å¸¸è¯­éŸ³æµ‹è¯•å¤±è´¥', 'error');
                log('æ­£å¸¸è¯­éŸ³æµ‹è¯•å¤±è´¥', 'error');
            }
            
            isTestRunning = false;
        };

        // æµ‹è¯•å¤±è´¥è¯­éŸ³
        window.testFailureSpeech = async function() {
            if (isTestRunning) return;
            isTestRunning = true;
            
            log('=== å¼€å§‹æµ‹è¯•å¤±è´¥è¯­éŸ³å¤„ç† ===');
            updateStatus('æ­£åœ¨æµ‹è¯•å¤±è´¥è¯­éŸ³...', 'loading');
            
            const result = await simulateRetryLogic('This will fail', 2, true, 'normal');
            
            if (!result) {
                updateStatus('âœ… å¤±è´¥å¤„ç†æµ‹è¯•é€šè¿‡ï¼ˆæ­£ç¡®åœæ­¢é‡è¯•ï¼‰', 'success');
                log('å¤±è´¥å¤„ç†æµ‹è¯•å®Œæˆ', 'success');
            } else {
                updateStatus('âŒ å¤±è´¥å¤„ç†æµ‹è¯•å¼‚å¸¸', 'error');
                log('å¤±è´¥å¤„ç†æµ‹è¯•å¼‚å¸¸', 'error');
            }
            
            isTestRunning = false;
        };

        // æµ‹è¯•é‡è¯•é™åˆ¶
        window.testRetryLimit = async function() {
            if (isTestRunning) return;
            isTestRunning = true;
            
            log('=== å¼€å§‹æµ‹è¯•é‡è¯•é™åˆ¶æœºåˆ¶ ===');
            updateStatus('æ­£åœ¨æµ‹è¯•é‡è¯•é™åˆ¶...', 'loading');
            
            const result = await simulateRetryLogic('Test retry limit', 2, true, 'fatal');
            
            if (!result) {
                updateStatus('âœ… é‡è¯•é™åˆ¶æµ‹è¯•é€šè¿‡ï¼ˆè‡´å‘½é”™è¯¯ä¸é‡è¯•ï¼‰', 'success');
                log('é‡è¯•é™åˆ¶æµ‹è¯•å®Œæˆ', 'success');
            } else {
                updateStatus('âŒ é‡è¯•é™åˆ¶æµ‹è¯•å¤±è´¥', 'error');
                log('é‡è¯•é™åˆ¶æµ‹è¯•å¤±è´¥', 'error');
            }
            
            isTestRunning = false;
        };

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type) {
            const resultsContainer = document.getElementById('testResults');
            resultsContainer.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•');
            log('ä¿®å¤å†…å®¹ï¼šé˜²æ­¢æ­»å¾ªç¯ã€é™åˆ¶é‡è¯•æ¬¡æ•°ã€ç»„ä»¶å¸è½½ä¿æŠ¤');
        });
    </script>
</body>
</html>
